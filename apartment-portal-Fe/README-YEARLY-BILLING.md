# ğŸ“‹ HÆ°á»›ng dáº«n sá»­ dá»¥ng tÃ­nh nÄƒng Táº¡o biá»ƒu phÃ­ nÄƒm hiá»‡n táº¡i

## ğŸ¯ Tá»•ng quan

TÃ­nh nÄƒng "Táº¡o biá»ƒu phÃ­ nÄƒm hiá»‡n táº¡i" cho phÃ©p admin táº¡o biá»ƒu phÃ­ dá»‹ch vá»¥ cho táº¥t cáº£ cÄƒn há»™ hoáº·c má»™t cÄƒn há»™ cá»¥ thá»ƒ trong nÄƒm hiá»‡n táº¡i vá»›i 3 loáº¡i phÃ­ chÃ­nh:
- **PhÃ­ dá»‹ch vá»¥ theo mÂ²**: TÃ­nh theo diá»‡n tÃ­ch cÄƒn há»™
- **PhÃ­ nÆ°á»›c theo mÂ³**: TÃ­nh theo chá»‰ sá»‘ nÆ°á»›c tiÃªu thá»¥  
- **PhÃ­ gá»­i xe**: TÃ­nh theo loáº¡i xe (xe mÃ¡y, Ã´ tÃ´ 4 chá»—, Ã´ tÃ´ 7 chá»—)

**âš ï¸ LÆ°u Ã½ quan trá»ng**: CÃ³ thá»ƒ táº¡o biá»ƒu phÃ­ cáº¥u hÃ¬nh cho nÄƒm hiá»‡n táº¡i vÃ  cÃ¡c nÄƒm khÃ¡c. Há»‡ thá»‘ng sáº½ kiá»ƒm tra vÃ  thÃ´ng bÃ¡o tráº¡ng thÃ¡i cá»§a tá»«ng nÄƒm.

## ğŸš€ CÃ¡ch truy cáº­p

1. ÄÄƒng nháº­p vÃ o há»‡ thá»‘ng vá»›i tÃ i khoáº£n Admin
2. VÃ o menu **"Táº¡o biá»ƒu phÃ­ nÄƒm hiá»‡n táº¡i"** trong sidebar
3. Hoáº·c truy cáº­p trá»±c tiáº¿p: `/admin-dashboard/yearly-billing`

## ğŸ“Š CÃ¡c tab chÃ­nh

### 1. **Tab "Táº¡o biá»ƒu phÃ­"**
- Form chÃ­nh Ä‘á»ƒ táº¡o biá»ƒu phÃ­ cho nÄƒm hiá»‡n táº¡i
- **2 loáº¡i hÃ nh Ä‘á»™ng**:
  - âœ… **Táº¡o hÃ³a Ä‘Æ¡n**: Táº¡o cáº¥u hÃ¬nh phÃ­ + hÃ³a Ä‘Æ¡n cho 12 thÃ¡ng
  - âœ… **Chá»‰ táº¡o cáº¥u hÃ¬nh**: Chá»‰ táº¡o cáº¥u hÃ¬nh phÃ­ cho 12 thÃ¡ng
- Chá»n pháº¡m vi (táº¥t cáº£ cÄƒn há»™ hoáº·c cÄƒn há»™ cá»¥ thá»ƒ)
- Cáº¥u hÃ¬nh Ä‘Æ¡n giÃ¡ cho 5 loáº¡i phÃ­
- Xem tÃ³m táº¯t Ä‘Æ¡n giÃ¡ trÆ°á»›c khi táº¡o

### 2. **Tab "Cáº¥u hÃ¬nh phÃ­"**
- Xem vÃ  chá»‰nh sá»­a cáº¥u hÃ¬nh phÃ­ cho thÃ¡ng hiá»‡n táº¡i
- Táº¡o cáº¥u hÃ¬nh má»›i náº¿u chÆ°a cÃ³
- Cáº­p nháº­t Ä‘Æ¡n giÃ¡ theo tá»«ng thÃ¡ng

### 3. **Tab "Lá»‹ch sá»­"**
- Xem lá»‹ch sá»­ táº¡o biá»ƒu phÃ­
- Lá»c theo nÄƒm
- Thá»‘ng kÃª tá»•ng quan vá» cÃ¡c láº§n táº¡o biá»ƒu phÃ­

### 4. **Tab "ThÃ´ng tin"**
- HÆ°á»›ng dáº«n cÃ¡ch hoáº¡t Ä‘á»™ng
- CÃ¡ch tÃ­nh phÃ­ chi tiáº¿t
- LÆ°u Ã½ quan trá»ng

## ğŸ’° CÃ¡ch tÃ­nh phÃ­

### PhÃ­ dá»‹ch vá»¥
```
PhÃ­ dá»‹ch vá»¥ = Diá»‡n tÃ­ch cÄƒn há»™ (mÂ²) Ã— ÄÆ¡n giÃ¡ (VND/mÂ²)
```

### PhÃ­ nÆ°á»›c
```
PhÃ­ nÆ°á»›c = LÆ°á»£ng nÆ°á»›c tiÃªu thá»¥ (mÂ³) Ã— ÄÆ¡n giÃ¡ (VND/mÂ³)
```

### PhÃ­ gá»­i xe
```
PhÃ­ gá»­i xe = Sá»‘ xe Ã— ÄÆ¡n giÃ¡ theo loáº¡i xe
```

**CÃ¡c loáº¡i xe Ä‘Æ°á»£c tÃ­nh phÃ­:**
- **Xe mÃ¡y**: 50,000 VND/thÃ¡ng
- **Ã” tÃ´ 4 chá»—**: 200,000 VND/thÃ¡ng  
- **Ã” tÃ´ 7 chá»—**: 250,000 VND/thÃ¡ng

**KhÃ´ng tÃ­nh phÃ­:** Xe Ä‘áº¡p, xe táº£i, xe van, xe Ä‘iá»‡n

## ğŸ¯ CÃ¡c bÆ°á»›c táº¡o biá»ƒu phÃ­

### BÆ°á»›c 1: Chá»n loáº¡i hÃ nh Ä‘á»™ng
- **Táº¡o hÃ³a Ä‘Æ¡n**: Táº¡o cáº¥u hÃ¬nh phÃ­ VÃ€ hÃ³a Ä‘Æ¡n cho 12 thÃ¡ng
- **Chá»‰ táº¡o cáº¥u hÃ¬nh**: Chá»‰ táº¡o cáº¥u hÃ¬nh phÃ­ cho 12 thÃ¡ng (khÃ´ng táº¡o hÃ³a Ä‘Æ¡n)

### BÆ°á»›c 2: Chá»n pháº¡m vi
- **Pháº¡m vi** (chá»‰ khi chá»n "Táº¡o hÃ³a Ä‘Æ¡n"): 
  - âœ… Táº¥t cáº£ cÄƒn há»™: Táº¡o biá»ƒu phÃ­ cho táº¥t cáº£ cÄƒn há»™
  - âœ… CÄƒn há»™ cá»¥ thá»ƒ: Chá»n má»™t cÄƒn há»™ tá»« danh sÃ¡ch

### BÆ°á»›c 3: Cáº¥u hÃ¬nh Ä‘Æ¡n giÃ¡
- **PhÃ­ dá»‹ch vá»¥**: ÄÆ¡n giÃ¡/mÂ² (VND) - Tá»« 1 Ä‘áº¿n 100,000 VND/mÂ²
- **PhÃ­ nÆ°á»›c**: ÄÆ¡n giÃ¡/mÂ³ (VND) - Tá»« 1 Ä‘áº¿n 50,000 VND/mÂ³
- **PhÃ­ xe mÃ¡y**: ÄÆ¡n giÃ¡/thÃ¡ng - Tá»« 1 Ä‘áº¿n 200,000 VND/thÃ¡ng
- **PhÃ­ Ã´ tÃ´ 4 chá»—**: ÄÆ¡n giÃ¡/thÃ¡ng - Tá»« 1 Ä‘áº¿n 1,000,000 VND/thÃ¡ng
- **PhÃ­ Ã´ tÃ´ 7 chá»—**: ÄÆ¡n giÃ¡/thÃ¡ng - Tá»« 1 Ä‘áº¿n 1,500,000 VND/thÃ¡ng

### BÆ°á»›c 4: Xem tÃ³m táº¯t vÃ  táº¡o
- Kiá»ƒm tra tÃ³m táº¯t Ä‘Æ¡n giÃ¡
- Nháº¥n "Táº¡o hÃ³a Ä‘Æ¡n nÄƒm hiá»‡n táº¡i" hoáº·c "Táº¡o cáº¥u hÃ¬nh phÃ­"
- Há»‡ thá»‘ng sáº½ táº¡o cáº¥u hÃ¬nh/hÃ³a Ä‘Æ¡n cho 12 thÃ¡ng

## âš™ï¸ Cáº¥u hÃ¬nh phÃ­

### Xem cáº¥u hÃ¬nh hiá»‡n táº¡i
1. Chuyá»ƒn sang tab "Cáº¥u hÃ¬nh phÃ­"
2. Xem Ä‘Æ¡n giÃ¡ cá»§a thÃ¡ng hiá»‡n táº¡i
3. Nháº¥n "Chá»‰nh sá»­a" Ä‘á»ƒ thay Ä‘á»•i

### Táº¡o cáº¥u hÃ¬nh má»›i
1. Náº¿u chÆ°a cÃ³ cáº¥u hÃ¬nh, nháº¥n "Táº¡o cáº¥u hÃ¬nh má»›i"
2. Nháº­p Ä‘Æ¡n giÃ¡ cho 5 loáº¡i phÃ­
3. Nháº¥n "LÆ°u"

### Cáº­p nháº­t cáº¥u hÃ¬nh
1. Nháº¥n "Chá»‰nh sá»­a"
2. Thay Ä‘á»•i Ä‘Æ¡n giÃ¡
3. Nháº¥n "LÆ°u" Ä‘á»ƒ cáº­p nháº­t

## ğŸ“ˆ Xem lá»‹ch sá»­

### Lá»c theo nÄƒm
1. Chuyá»ƒn sang tab "Lá»‹ch sá»­"
2. Chá»n nÄƒm cáº§n xem
3. Nháº¥n "Lá»c"

### ThÃ´ng tin hiá»ƒn thá»‹
- **Thá»i gian**: NgÃ y giá» táº¡o biá»ƒu phÃ­
- **NÄƒm**: NÄƒm Ä‘Æ°á»£c táº¡o biá»ƒu phÃ­
- **Pháº¡m vi**: Táº¥t cáº£ cÄƒn há»™ hoáº·c cÄƒn há»™ cá»¥ thá»ƒ
- **ÄÆ¡n giÃ¡**: 5 loáº¡i phÃ­ Ä‘Æ°á»£c Ã¡p dá»¥ng
- **Káº¿t quáº£**: ThÃ´ng bÃ¡o káº¿t quáº£ táº¡o biá»ƒu phÃ­
- **HÃ³a Ä‘Æ¡n**: Sá»‘ lÆ°á»£ng hÃ³a Ä‘Æ¡n Ä‘Æ°á»£c táº¡o
- **Tá»•ng tiá»n**: Tá»•ng sá»‘ tiá»n cá»§a táº¥t cáº£ hÃ³a Ä‘Æ¡n
- **Tráº¡ng thÃ¡i**: ThÃ nh cÃ´ng/Tháº¥t báº¡i/Má»™t pháº§n

## âš ï¸ LÆ°u Ã½ quan trá»ng

### Giá»›i háº¡n nÄƒm
- âœ… **Chá»n nÄƒm linh hoáº¡t**: CÃ³ thá»ƒ táº¡o biá»ƒu phÃ­ cho nÄƒm hiá»‡n táº¡i vÃ  cÃ¡c nÄƒm khÃ¡c
- âŒ **KhÃ´ng cho phÃ©p**: Táº¡o biá»ƒu phÃ­ cho nÄƒm quÃ¡ khá»© hoáº·c tÆ°Æ¡ng lai
- ğŸš« **KhÃ´ng táº¡o láº¡i**: NÄƒm Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh phÃ­ dá»‹ch vá»¥ khÃ´ng thá»ƒ táº¡o láº¡i
- ğŸ”’ **Báº£o máº­t**: NgÄƒn cháº·n viá»‡c táº¡o biá»ƒu phÃ­ khÃ´ng há»£p lá»‡

### Dá»¯ liá»‡u cáº§n thiáº¿t
- âœ… **Diá»‡n tÃ­ch cÄƒn há»™**: Cáº§n cÃ³ trong báº£ng `apartments`
- âœ… **Chá»‰ sá»‘ nÆ°á»›c**: Cáº§n cÃ³ trong báº£ng `water_meter_readings`
- âœ… **Xe cá»™**: Chá»‰ tÃ­nh xe mÃ¡y, Ã´ tÃ´ 4 chá»—, Ã´ tÃ´ 7 chá»— Ä‘Ã£ Ä‘Æ°á»£c approved
- âœ… **CÆ° dÃ¢n**: Cáº§n cÃ³ thÃ´ng tin cÆ° dÃ¢n liÃªn káº¿t vá»›i cÄƒn há»™

### Kiá»ƒm tra trÃ¹ng láº·p
- Há»‡ thá»‘ng tá»± Ä‘á»™ng kiá»ƒm tra vÃ  bá» qua hÃ³a Ä‘Æ¡n Ä‘Ã£ tá»“n táº¡i
- TrÃ¡nh táº¡o hÃ³a Ä‘Æ¡n trÃ¹ng láº·p cho cÃ¹ng thÃ¡ng

### Xá»­ lÃ½ lá»—i
- Náº¿u khÃ´ng cÃ³ chá»‰ sá»‘ nÆ°á»›c â†’ PhÃ­ nÆ°á»›c = 0
- Náº¿u khÃ´ng cÃ³ xe mÃ¡y/Ã´ tÃ´ â†’ PhÃ­ gá»­i xe = 0
- Náº¿u khÃ´ng cÃ³ diá»‡n tÃ­ch cÄƒn há»™ â†’ PhÃ­ dá»‹ch vá»¥ = 0

## ğŸ”§ Troubleshooting

### Lá»—i "Chá»‰ Ä‘Æ°á»£c táº¡o biá»ƒu phÃ­ cho nÄƒm hiá»‡n táº¡i"

**NguyÃªn nhÃ¢n**: Há»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ cho phÃ©p táº¡o biá»ƒu phÃ­ cho cÃ¡c nÄƒm khÃ¡c.

**Giáº£i phÃ¡p**:
1. âœ… **ÄÃ£ sá»­a**: Validation giá»›i háº¡n nÄƒm Ä‘Ã£ Ä‘Æ°á»£c loáº¡i bá»
2. âœ… **TÃ­nh nÄƒng má»›i**: CÃ³ thá»ƒ chá»n nÄƒm tá»« dropdown (tá»« currentYear - 5 Ä‘áº¿n currentYear + 5)
3. âœ… **Kiá»ƒm tra tá»± Ä‘á»™ng**: Há»‡ thá»‘ng sáº½ kiá»ƒm tra vÃ  thÃ´ng bÃ¡o tráº¡ng thÃ¡i cá»§a tá»«ng nÄƒm
4. âœ… **ThÃ´ng bÃ¡o thÃ´ng minh**: Hiá»ƒn thá»‹ "ÄÃ£ cÃ³ cáº¥u hÃ¬nh" hoáº·c "ChÆ°a cÃ³ cáº¥u hÃ¬nh" cho tá»«ng nÄƒm

### Lá»—i "NÄƒm X Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh phÃ­ dá»‹ch vá»¥"

**NguyÃªn nhÃ¢n**: Cá»‘ gáº¯ng táº¡o biá»ƒu phÃ­ cho nÄƒm Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh.

**Giáº£i phÃ¡p**:
1. âœ… **Chá»n nÄƒm khÃ¡c**: Chá»n nÄƒm chÆ°a cÃ³ cáº¥u hÃ¬nh tá»« dropdown
2. âœ… **Sá»­ dá»¥ng tab "Cáº¥u hÃ¬nh phÃ­"**: Äá»ƒ chá»‰nh sá»­a cáº¥u hÃ¬nh hiá»‡n táº¡i
3. âœ… **Kiá»ƒm tra tráº¡ng thÃ¡i**: Xem thÃ´ng bÃ¡o "ÄÃ£ cÃ³ cáº¥u hÃ¬nh (khÃ´ng thá»ƒ táº¡o láº¡i)"
4. âœ… **NÃºt bá»‹ disable**: NÃºt submit sáº½ bá»‹ vÃ´ hiá»‡u hÃ³a khi nÄƒm Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh

### Lá»—i "Invoice not found"
- Kiá»ƒm tra xem hÃ³a Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c táº¡o chÆ°a
- Äáº£m báº£o apartmentId tá»“n táº¡i trong database

### Lá»—i "Service fee config not found"
- Táº¡o cáº¥u hÃ¬nh phÃ­ dá»‹ch vá»¥ trÆ°á»›c khi táº¡o biá»ƒu phÃ­
- Sá»­ dá»¥ng tab "Cáº¥u hÃ¬nh phÃ­" Ä‘á»ƒ táº¡o cáº¥u hÃ¬nh

### PhÃ­ nÆ°á»›c báº±ng 0
- Kiá»ƒm tra chá»‰ sá»‘ nÆ°á»›c trong báº£ng `water_meter_readings`
- Äáº£m báº£o cÃ³ dá»¯ liá»‡u cho thÃ¡ng cáº§n tÃ­nh

### PhÃ­ gá»­i xe báº±ng 0
- Kiá»ƒm tra xe mÃ¡y/Ã´ tÃ´ Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½ chÆ°a
- Äáº£m báº£o xe cÃ³ tráº¡ng thÃ¡i APPROVED
- Kiá»ƒm tra thÃ´ng tin cÆ° dÃ¢n liÃªn káº¿t vá»›i cÄƒn há»™

### ğŸš¨ Lá»—i "chk_invoice_amount constraint violation"

**MÃ´ táº£ lá»—i:**
```
Lá»—i khi táº¡o biá»ƒu phÃ­: could not execute statement [Check constraint 'chk_invoice_amount' is violated.] 
[insert into invoices (apartment_id,billing_period,created_at,due_date,issue_date,status,total_amount,updated_at) 
values (?,?,?,?,?,?,?,?)]
```

**NguyÃªn nhÃ¢n cÃ³ thá»ƒ:**
1. **Dá»¯ liá»‡u cÄƒn há»™ khÃ´ng há»£p lá»‡**: Diá»‡n tÃ­ch cÄƒn há»™ = 0 hoáº·c NULL
2. **Chá»‰ sá»‘ nÆ°á»›c Ã¢m**: LÆ°á»£ng tiÃªu thá»¥ nÆ°á»›c Ã¢m do lá»—i nháº­p liá»‡u
3. **Thiáº¿u dá»¯ liá»‡u xe cá»™**: KhÃ´ng cÃ³ thÃ´ng tin xe Ä‘Ã£ Ä‘Äƒng kÃ½
4. **Lá»—i tÃ­nh toÃ¡n**: Tá»•ng tiá»n hÃ³a Ä‘Æ¡n = 0 hoáº·c Ã¢m

**CÃ¡ch kháº¯c phá»¥c:**

#### BÆ°á»›c 1: Kiá»ƒm tra dá»¯ liá»‡u cÄƒn há»™
```sql
-- Kiá»ƒm tra cÄƒn há»™ cÃ³ diá»‡n tÃ­ch há»£p lá»‡
SELECT id, unit_number, area, building, floor
FROM apartments 
WHERE area IS NULL OR area <= 0;
```

#### BÆ°á»›c 2: Kiá»ƒm tra chá»‰ sá»‘ nÆ°á»›c
```sql
-- Kiá»ƒm tra chá»‰ sá»‘ nÆ°á»›c Ã¢m
SELECT apartment_id, reading_month, current_reading, previous_reading
FROM water_meter_readings 
WHERE current_reading < previous_reading;
```

#### BÆ°á»›c 3: Kiá»ƒm tra xe cá»™
```sql
-- Kiá»ƒm tra xe Ä‘Ã£ Ä‘Äƒng kÃ½
SELECT apartment_id, vehicle_type, status, COUNT(*) as count
FROM vehicles 
WHERE apartment_id IS NOT NULL 
  AND status = 'APPROVED'
  AND vehicle_type IN ('MOTORBIKE', 'CAR_4_SEATS', 'CAR_7_SEATS')
GROUP BY apartment_id, vehicle_type, status;
```

#### BÆ°á»›c 4: Thá»­ láº¡i vá»›i dá»¯ liá»‡u há»£p lá»‡
1. Cáº­p nháº­t diá»‡n tÃ­ch cÄƒn há»™ náº¿u cáº§n
2. Sá»­a chá»‰ sá»‘ nÆ°á»›c Ã¢m
3. ÄÄƒng kÃ½ xe cá»™ náº¿u cáº§n
4. Thá»­ táº¡o biá»ƒu phÃ­ láº¡i

**LÆ°u Ã½:** Há»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c cáº£i thiá»‡n Ä‘á»ƒ:
- âœ… Kiá»ƒm tra dá»¯ liá»‡u Ä‘áº§u vÃ o trÆ°á»›c khi gá»­i
- âœ… Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i chi tiáº¿t hÆ¡n
- âœ… NgÄƒn cháº·n viá»‡c gá»­i dá»¯ liá»‡u khÃ´ng há»£p lá»‡
- âœ… Chá»‰ cho phÃ©p táº¡o biá»ƒu phÃ­ cho nÄƒm hiá»‡n táº¡i

## ğŸ¯ Káº¿t luáº­n

TÃ­nh nÄƒng "Táº¡o biá»ƒu phÃ­ nÄƒm hiá»‡n táº¡i" Ä‘Ã£ Ä‘Æ°á»£c tÃ­ch há»£p hoÃ n chá»‰nh vá»›i:
- âœ… Form táº¡o biá»ƒu phÃ­ vá»›i validation Ä‘áº§y Ä‘á»§
- âœ… **Chá»n nÄƒm linh hoáº¡t**: CÃ³ thá»ƒ táº¡o biá»ƒu phÃ­ cho nÄƒm hiá»‡n táº¡i vÃ  cÃ¡c nÄƒm khÃ¡c
- âœ… **NgÄƒn cháº·n táº¡o láº¡i**: KhÃ´ng cho phÃ©p táº¡o biá»ƒu phÃ­ cho nÄƒm Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh
- âœ… 2 loáº¡i hÃ nh Ä‘á»™ng: Táº¡o hÃ³a Ä‘Æ¡n hoáº·c chá»‰ táº¡o cáº¥u hÃ¬nh
- âœ… Quáº£n lÃ½ cáº¥u hÃ¬nh phÃ­ theo thÃ¡ng vá»›i 5 loáº¡i phÃ­
- âœ… Xem lá»‹ch sá»­ táº¡o biá»ƒu phÃ­
- âœ… HÆ°á»›ng dáº«n chi tiáº¿t vÃ  troubleshooting
- âœ… UI/UX thÃ¢n thiá»‡n vÃ  dá»… sá»­ dá»¥ng
- âœ… Xá»­ lÃ½ lá»—i nÃ¢ng cao vá»›i thÃ´ng bÃ¡o chi tiáº¿t

Admin cÃ³ thá»ƒ báº¯t Ä‘áº§u sá»­ dá»¥ng ngay Ä‘á»ƒ táº¡o biá»ƒu phÃ­ cho cÆ° dÃ¢n trong nÄƒm hiá»‡n táº¡i! ğŸš€ 