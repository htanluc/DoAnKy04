package com.mytech.apartment.portal.config;

import java.util.HashSet;
import java.util.Set;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

import com.mytech.apartment.portal.models.Role;
import com.mytech.apartment.portal.models.User;
import com.mytech.apartment.portal.repositories.RoleRepository;
import com.mytech.apartment.portal.repositories.UserRepository;

@Component
public class DataInitializer implements CommandLineRunner {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public void run(String... args) throws Exception {
        System.out.println("ğŸš€ Starting DataInitializer...");

        try {
            // Táº¡o cÃ¡c role cáº§n thiáº¿t
            createRoles();

            // Táº¡o user Admin
            createAdminUser();

            System.out.println("âœ… DataInitializer completed successfully!");
        } catch (Exception e) {
            System.err.println("âŒ Error in DataInitializer: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void createRoles() {
        System.out.println("ğŸ“ Creating roles...");

        // Táº¡o role ADMIN náº¿u chÆ°a tá»“n táº¡i
        if (!roleRepository.findByName("ADMIN").isPresent()) {
            Role adminRole = Role.builder()
                    .name("ADMIN")
                    .build();
            Role savedAdminRole = roleRepository.save(adminRole);
            System.out.println("âœ… Created ADMIN role with ID: " + savedAdminRole.getId());
        } else {
            System.out.println("â„¹ï¸ ADMIN role already exists");
        }

        // Táº¡o role RESIDENT náº¿u chÆ°a tá»“n táº¡i
        if (!roleRepository.findByName("RESIDENT").isPresent()) {
            Role residentRole = Role.builder()
                    .name("RESIDENT")
                    .build();
            Role savedResidentRole = roleRepository.save(residentRole);
            System.out.println("âœ… Created RESIDENT role with ID: " + savedResidentRole.getId());
        } else {
            System.out.println("â„¹ï¸ RESIDENT role already exists");
        }

        // Táº¡o role STAFF náº¿u chÆ°a tá»“n táº¡i
        if (!roleRepository.findByName("STAFF").isPresent()) {
            Role staffRole = Role.builder()
                    .name("STAFF")
                    .build();
            Role savedStaffRole = roleRepository.save(staffRole);
            System.out.println("âœ… Created STAFF role with ID: " + savedStaffRole.getId());
        } else {
            System.out.println("â„¹ï¸ STAFF role already exists");
        }
    }

    private void createAdminUser() {
        System.out.println("ğŸ‘¤ Creating admin user...");

        // Kiá»ƒm tra xem user Admin Ä‘Ã£ tá»“n táº¡i chÆ°a
        if (!userRepository.findByUsername("admin").isPresent()) {
            try {
                // Láº¥y role ADMIN
                Role adminRole = roleRepository.findByName("ADMIN")
                        .orElseThrow(() -> new RuntimeException("ADMIN role not found"));

                // Táº¡o set roles cho admin
                Set<Role> adminRoles = new HashSet<>();
                adminRoles.add(adminRole);

                // Encode password
                String rawPassword = "admin123";
                String encodedPassword = passwordEncoder.encode(rawPassword);
                System.out.println("ğŸ” Raw password: " + rawPassword);
                System.out.println("ğŸ” Encoded password: " + encodedPassword);

                // Táº¡o user Admin
                User adminUser = User.builder()
                        .username("admin")
                        .email("admin@apartment.com")
                        .passwordHash(encodedPassword)
                        .phoneNumber("admin")
                        .status("ACTIVE")
                        .roles(adminRoles)
                        .build();

                User savedAdminUser = userRepository.save(adminUser);
                System.out.println("âœ… Admin user created successfully!");
                System.out.println("ğŸ“± Username: admin");
                System.out.println("ğŸ”‘ Password: admin123");
                System.out.println("ğŸ“ Phone: admin");
                System.out.println("ğŸ†” User ID: " + savedAdminUser.getId());

                // Verify the password can be matched
                boolean passwordMatches = passwordEncoder.matches(rawPassword, savedAdminUser.getPasswordHash());
                System.out.println("ğŸ” Password verification test: " + passwordMatches);

            } catch (Exception e) {
                System.err.println("âŒ Error creating admin user: " + e.getMessage());
                e.printStackTrace();
            }
        } else {
            System.out.println("â„¹ï¸ Admin user already exists");

            // Check existing admin user
            userRepository.findByUsername("admin").ifPresent(existingUser -> {
                System.out.println("ğŸ“‹ Existing admin user details:");
                System.out.println("ğŸ†” ID: " + existingUser.getId());
                System.out.println("ğŸ“± Username: " + existingUser.getUsername());
                System.out.println("ğŸ“ Phone: " + existingUser.getPhoneNumber());
                System.out.println("ğŸ” Password hash: " + existingUser.getPasswordHash());

                // Test password matching
                boolean passwordMatches = passwordEncoder.matches("admin123", existingUser.getPasswordHash());
                System.out.println("ğŸ” Password verification test: " + passwordMatches);
            });
        }
    }
}